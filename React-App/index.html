<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMATR</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <header>
        <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
        <button class="home-button" id="home">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
        </button>
    </header>
    <main>
        <h2>Select the Class</h2>
        <button id="class1">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/classroom.png" class="camera-icon" alt="Class 1"/>
            Class 1
        </button>
        <button id="class2">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/classroom.png" class="camera-icon" alt="Class 2"/>
            Class 2
        </button>
    </main>
    <button class="back-button" id="back" style="display: none;">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const initialContent = document.body.innerHTML;

        function updateContent(content, title) {
            document.body.innerHTML = content;
            document.title = title;
            attachEventListeners();
            window.history.pushState({ content: content, title: title }, title);
        }

        window.addEventListener('popstate', (event) => {
            if (event.state) {
                document.body.innerHTML = event.state.content;
                document.title = event.state.title;
                attachEventListeners();
            } else {
                document.body.innerHTML = initialContent;
                document.title = 'SMATR';
                attachEventListeners();
            }
        });

        function attachEventListeners() {
            if (document.getElementById('class1')) {
                document.getElementById('class1').addEventListener('click', () => {
                    showOptions('Class 1');
                });
            }

            if (document.getElementById('class2')) {
                document.getElementById('class2').addEventListener('click', () => {
                    showOptions('Class 2');
                });
            }

            if (document.getElementById('home')) {
                document.getElementById('home').addEventListener('click', () => {
                    location.reload();
                });
            }

            if (document.getElementById('back')) {
                document.getElementById('back').addEventListener('click', () => {
                    history.back();
                });
            }

            if (document.getElementById('attendance')) {
                document.getElementById('attendance').addEventListener('click', () => {
                    const date = document.getElementById('datepicker').value;
                    if (date) {
                        fetchAttendanceData(date);
                    } else {
                        alert("Please select a date.");
                    }
                });
            }

            if (document.getElementById('attentiveness')) {
                document.getElementById('attentiveness').addEventListener('click', () => {
                    const date = document.getElementById('datepicker').value;
                    if (date) {
                        fetchAttentivenessData(date);
                    } else {
                        alert("Please select a date.");
                    }
                });
            }

            if (document.getElementById('datepicker')) {
                flatpickr("#datepicker", {
                    dateFormat: "Y-m-d",
                });
            }
        }

        function showOptions(className) {
            const content = `
                <header>
                    <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
                    <button class="home-button" id="home">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
                    </button>
                </header>
                <main>
                    <h2>${className}</h2>
                    <div class="calendar">
                        <input type="text" id="datepicker" placeholder="Select Date">
                    </div>
                    <button id="attendance">Attendance</button>
                    <button id="attentiveness">Attentiveness</button>
                </main>
                <button class="back-button" id="back">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
                </button>
            `;
            updateContent(content, 'SMATR - ' + className);
        }

        function showResult(option, data) {
            let chartContent = '';
            if (option === 'Attentiveness') {
                chartContent = `
                    <canvas id="attentivenessChart"></canvas>
                    <canvas id="attentivenessPieChart"></canvas>
                `;
                setTimeout(() => renderAttentivenessCharts(data), 0);
            }

            const content = `
                <header>
                    <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
                    <button class="home-button" id="home">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
                    </button>
                </header>
                <main>
                    <h2>${option} Records</h2>
                    ${chartContent}
                </main>
                <button class="back-button" id="back">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
                </button>
            `;
            updateContent(content, 'SMATR - ' + option);
        }

        async function fetchAttendanceData(date) {
            const data = await window.api.fetchAttendance(date);
            if (data.error) {
                const content = `
                    <header>
                        <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
                        <button class="home-button" id="home">
                            <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
                        </button>
                    </header>
                    <main>
                        <h2>No Records Found</h2>
                        <p>No class records found on this date</p>
                    </main>
                    <button class="back-button" id="back">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
                    </button>
                `;
                updateContent(content, 'SMATR - Error');
                return;
            }

            const tableRows = data.map(item => `
                <tr>
                    <td>${item[0]}</td>
                </tr>
            `).join('');

            const content = `
                <header>
                    <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
                    <button class="home-button" id="home">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
                    </button>
                </header>
                <main>
                    <h2>Attendance Records</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </main>
                <button class="back-button" id="back">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
                </button>
            `;
            updateContent(content, 'SMATR - Attendance');
        }

        async function fetchAttentivenessData(date) {
            const data = await window.api.fetchAttentiveness(date);
            if (data.error) {
                const content = `
                    <header>
                        <div class="header-title">SMATR: Smart Attendance and Attentiveness Tracking</div>
                        <button class="home-button" id="home">
                            <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home"/>
                        </button>
                    </header>
                    <main>
                        <h2>No Records Found</h2>
                        <p>No class records found on this date</p>
                    </main>
                    <button class="back-button" id="back">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/back.png" class="camera-icon" alt="Back"/>
                    </button>
                `;
                updateContent(content, 'SMATR - Error');
                return;
            }

            showResult('Attentiveness', data);
        }
    function renderAttentivenessCharts(data) {
    const ctx = document.getElementById('attentivenessChart').getContext('2d');
    const pieCtx = document.getElementById('attentivenessPieChart').getContext('2d');

    const timestamps = data.map(item => parseFloat(item[0]).toFixed(2));
    const attentivePercentage = data.map(item => item[1]);

    const totalAttentivePercentage = attentivePercentage.reduce((acc, val) => acc + val, 0);
    const averageAttentivePercentage = totalAttentivePercentage / attentivePercentage.length;
    const averageNonAttentivePercentage = 100 - averageAttentivePercentage;

    const isBelowThreshold = attentivePercentage.some(percentage => percentage < 30);
    if (isBelowThreshold) {
            alert("Warning: Attentiveness percentage dropped below 30%!");
        }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timestamps,
            datasets: [{
                label: 'Attentiveness Percentage',
                data: attentivePercentage,
                borderColor: 'rgb(255, 205, 86)',
                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Timestamp(s)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Percentage'
                    }
                }
            }
        }
    });

    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Average Attentiveness during class', 'Average Non-Attentiveness during class'],
            datasets: [{
                data: [averageAttentivePercentage, averageNonAttentivePercentage],
                backgroundColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)']
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            return label + ': ' + value.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });

}

        attachEventListeners();
    </script>
</body>
</html>
